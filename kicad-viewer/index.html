<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>KiCad Viewer v2.0β — PWA＋URL読込対応</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="manifest.json">
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js')
    .then(()=>console.log('Service Worker registered'));
}
</script>
<style>
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;margin:12px;background:#fafafa;}
h1{font-size:18px;margin:0 0 8px;}
.row{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-start;}
.panel{background:#fff;border:1px solid #ddd;padding:10px;border-radius:8px;box-shadow:0 1px 2px rgba(0,0,0,0.04);}
.left{width:340px;min-width:260px;}
.right{flex:1;text-align:center;position:relative;}
canvas{border:1px solid #ccc;display:block;margin:0 auto;max-width:100%;touch-action:none;}
#bgCanvas{position:absolute;top:0;left:0;z-index:0;}
#hlCanvas{position:absolute;top:0;left:0;z-index:1;pointer-events:none;}
#log{font-family:monospace;background:#111;color:#ddd;padding:8px;height:100px;overflow:auto;border-radius:6px;}
.small{font-size:13px;color:#444;}
button{padding:6px 10px;font-size:14px;margin:3px;}
input[type=url]{width:100%;padding:5px;}
.valItem{display:flex;align-items:center;gap:6px;padding:3px 6px;cursor:pointer;border-radius:4px;}
.valItem.selected{background:#ffe6f5;}
.valItem input[type=checkbox]{cursor:pointer;transform:scale(1.2);flex-shrink:0;}
.valLabel{flex:1;}
</style>
</head>
<body>
<h1>KiCad Viewer v2.0β — PWA＋URL読込対応</h1>

<div class="row">
  <div class="panel left">
    <label>① PCBファイル（.kicad_pcb）</label>
    <input id="pcbFile" type="file" accept=".kicad_pcb,text/plain"><br>
    <label>② BOM（CSV, 任意）</label>
    <input id="bomFile" type="file" accept=".csv,text/csv"><br>
    <label>③ Front（F_Cu）</label>
    <input id="bgFileFront" type="file" accept=".svg"><br>
    <label>④ Back（B_Cu）</label>
    <input id="bgFileBack" type="file" accept=".svg"><br>

    <div style="margin-top:8px;">
      <input id="urlInput" type="url" placeholder="🔗 KiCadファイルのURLを入力">
      <button id="loadURL">URLから読み込み</button>
    </div>

    <div style="margin-top:10px;">
      <button id="toggleGray">grayscale</button>
      <button id="showFront">front</button>
      <button id="showBack">back</button>
    </div>

    <label>透過度（全体）</label>
    <input id="alphaSlider" type="range" min="0.1" max="1.0" step="0.05" value="1.0">

    <label>部品リスト</label>
    <div id="valueList" style="max-height:220px;overflow:auto;border:1px solid #ccc;padding:4px;border-radius:4px;"></div>

    <div style="margin-top:10px;">
      <label class="small">スケール <input id="scaleAdj" type="number" step="0.001" value="1.000" style="width:80px"></label><br>
      <label class="small">Xオフ <input id="oxAdj" type="number" step="0.01" value="0" style="width:80px"></label><br>
      <label class="small">Yオフ <input id="oyAdj" type="number" step="0.01" value="0" style="width:80px"></label>
    </div>

    <div style="margin-top:10px;">
      <div class="small">ログ</div>
      <div id="log"></div>
    </div>
  </div>

  <div class="panel right">
    <canvas id="bgCanvas" width="1000" height="800"></canvas>
    <canvas id="hlCanvas" width="1000" height="800"></canvas>
    <div class="small" style="margin-top:810px;">※タップ/ピンチは無効（固定表示）</div>
  </div>
</div>

<script>
const pcbInput=document.getElementById('pcbFile');
const bomInput=document.getElementById('bomFile');
const bgFrontInput=document.getElementById('bgFileFront');
const bgBackInput=document.getElementById('bgFileBack');
const bgCanvas=document.getElementById('bgCanvas');
const hlCanvas=document.getElementById('hlCanvas');
const bgCtx=bgCanvas.getContext('2d');
const hlCtx=hlCanvas.getContext('2d');
const logElem=document.getElementById('log');
const scaleAdjIn=document.getElementById('scaleAdj');
const oxAdjIn=document.getElementById('oxAdj');
const oyAdjIn=document.getElementById('oyAdj');
const valueList=document.getElementById('valueList');
const toggleGray=document.getElementById('toggleGray');
const showFront=document.getElementById('showFront');
const showBack=document.getElementById('showBack');
const alphaSlider=document.getElementById('alphaSlider');
const loadURL=document.getElementById('loadURL');
const urlInput=document.getElementById('urlInput');

let parts=[],bomMap={},bgImageFront=null,bgImageBack=null,bgViewBoxFront=null,bgViewBoxBack=null,baseScale=1;
let highlightValue=null,grayMode=false,alpha=1.0,currentSide="front";
let implementedValues=new Set();

function log(m){logElem.textContent=`[${new Date().toLocaleTimeString()}] ${m}\n`+logElem.textContent;}

function parseCSVtoMap(t){const rows=t.split(/\r?\n/).map(r=>r.trim()).filter(Boolean);const map={};for(const row of rows){const c=row.split(',');if(c.length>=2)map[c[0].trim()]=c[1].trim();}return map;}
function extractBlocks(t){const a=[],k='(footprint ';let i=t.indexOf(k);while(i!=-1){let d=0,s=i,e=-1;for(let j=s;j<t.length;j++){const c=t[j];if(c=='(')d++;else if(c==')'){d--;if(d==0){e=j;break;}}}if(e>s){a.push(t.slice(s,e+1));i=t.indexOf(k,e+1);}else break;}return a;}
function parseBlock(b){const at=b.match(/\(at\s+([\-0-9\.]+)\s+([\-0-9\.]+)/m);if(!at)return null;const x=parseFloat(at[1]),y=parseFloat(at[2]);const ref=(b.match(/\(fp_text\s+reference\s+"([^"]+)"/m)||b.match(/\(reference\s+"([^"]+)"/m))?.[1]||'?';let value=(b.match(/\(property\s+"Value"\s+"([^"]+)"/m)||b.match(/\(fp_text\s+value\s+"([^"]+)"/m))?.[1]||'(no value)';const layer=(b.match(/\(layer\s+"([^"]+)"/m))?.[1]||'F.Cu';return {ref,value,x,y,layer};}
function parseKiCadText(t){return extractBlocks(t).map(parseBlock).filter(Boolean);}

function mapToCanvasPx(p){
  const s=parseFloat(scaleAdjIn.value)||1.0,ox=parseFloat(oxAdjIn.value)||0,oy=parseFloat(oyAdjIn.value)||0;
  const vb=(currentSide==="front"?bgViewBoxFront:bgViewBoxBack)||bgViewBoxFront;
  const originX=(vb?.x||0)+ox,originY=(vb?.y||0)+oy;
  const ppm=baseScale*s;
  let px=(p.x-originX)*ppm;
  const py=(p.y-originY)*ppm;
  if(currentSide==="back") px = hlCanvas.width - px;
  return {x:px,y:py};
}

function drawBackground(){
 bgCtx.clearRect(0,0,bgCanvas.width,bgCanvas.height);
 bgCtx.fillStyle="#fff";bgCtx.fillRect(0,0,bgCanvas.width,bgCanvas.height);
 const bg=currentSide==="front"?bgImageFront:bgImageBack;
 if(!bg)return;
 if(grayMode)bgCtx.filter="grayscale(100%)";
 if(currentSide==="back"){
   bgCtx.save();bgCtx.translate(bgCanvas.width,0);bgCtx.scale(-1,1);
   bgCtx.drawImage(bg,0,0,bgCanvas.width,bgCanvas.height);
   bgCtx.restore();
 }else bgCtx.drawImage(bg,0,0,bgCanvas.width,bgCanvas.height);
 bgCtx.filter="none";
}

function drawHighlights(){
 hlCtx.clearRect(0,0,hlCanvas.width,hlCanvas.height);
 for(const p of parts){
   const pt=mapToCanvasPx(p);if(isNaN(pt.x)||isNaN(pt.y))continue;
   if(currentSide==="front" && p.layer.startsWith("B"))continue;
   if(currentSide==="back" && p.layer.startsWith("F"))continue;
   if(implementedValues.has(p.value)){
     hlCtx.beginPath();
     hlCtx.arc(pt.x,pt.y,3.5,0,Math.PI*2);
     hlCtx.fillStyle=`rgba(255,165,0,${alpha})`;
     hlCtx.strokeStyle=`rgba(0,0,0,${alpha})`;
     hlCtx.lineWidth=1;
     hlCtx.fill();hlCtx.stroke();continue;
   }
   let color=`rgba(0,255,255,${alpha})`;
   if(p.value===highlightValue)color=`rgba(255,51,204,${alpha})`;
   hlCtx.beginPath();hlCtx.arc(pt.x,pt.y,3.5,0,Math.PI*2);
   hlCtx.fillStyle=color;hlCtx.fill();hlCtx.strokeStyle=`rgba(0,0,0,${alpha})`;hlCtx.stroke();
 }
}

function draw(){drawBackground();drawHighlights();}

function loadSVGtoPNG(file,cb){
 const fr=new FileReader();
 fr.onload=()=>{
   const svg=fr.result;
   const vb=svg.match(/viewBox="([\d\.\-\s]+)"/);
   let viewBox=null;
   if(vb){const n=vb[1].trim().split(/\s+/).map(parseFloat);if(n.length===4)viewBox={x:n[0],y:n[1],w:n[2],h:n[3]};}
   const blob=new Blob([svg],{type:'image/svg+xml'});
   const url=URL.createObjectURL(blob);
   const img=new Image();
   img.onload=()=>{
     const off=document.createElement('canvas');
     off.width=img.width;off.height=img.height;
     const octx=off.getContext('2d');
     octx.fillStyle="#fff";octx.fillRect(0,0,off.width,off.height);
     octx.drawImage(img,0,0);
     const pngUrl=off.toDataURL('image/png');
     const png=new Image();
     png.onload=()=>{cb(png,viewBox);};
     png.src=pngUrl;
   };
   img.src=url;
 };
 fr.readAsText(file);
}

async function loadPCBfromURL(url){
 try{
   const res=await fetch(url);
   const text=await res.text();
   parts=parseKiCadText(text);
   populateList();draw();
   log(`URL読込完了: ${parts.length}件`);
 }catch(e){log("URL読込失敗："+e);}
}

loadURL.onclick=()=>{const url=urlInput.value.trim();if(!url)return alert("URLを入力してください。");loadPCBfromURL(url);};
pcbInput.onchange=e=>{const f=e.target.files[0];if(!f)return;const fr=new FileReader();fr.onload=()=>{parts=parseKiCadText(fr.result);populateList();draw();log(`PCB読込: ${parts.length}件`);};fr.readAsText(f);};
bomInput.onchange=e=>{const f=e.target.files[0];if(!f)return;const fr=new FileReader();fr.onload=()=>{bomMap=parseCSVtoMap(fr.result);populateList();draw();log(`BOM読込完了`);};fr.readAsText(f);};
bgFrontInput.onchange=e=>{if(!e.target.files[0])return;loadSVGtoPNG(e.target.files[0],(png,vb)=>{bgImageFront=png;bgViewBoxFront=vb;baseScale=(png.width/vb.w+png.height/vb.h)/2;bgCanvas.width=png.width;bgCanvas.height=png.height;hlCanvas.width=png.width;hlCanvas.height=png.height;draw();log("Front読込完了");});};
bgBackInput.onchange=e=>{if(!e.target.files[0])return;loadSVGtoPNG(e.target.files[0],(png,vb)=>{bgImageBack=png;bgViewBoxBack=vb;draw();log("Back読込完了");});};

function populateList(){
 const map={};for(const p of parts){map[p.value]=(map[p.value]||0)+1;}
 const sorted=Object.entries(map).sort((a,b)=>b[1]-a[1]);
 valueList.innerHTML=sorted.map(([v,c])=>`<div class="valItem" data-val="${v}"><input type="checkbox" class="valCheck" data-val="${v}"><span class="valLabel">${v} (${c})</span></div>`).join('');
 valueList.querySelectorAll('.valCheck').forEach(chk=>{
   chk.addEventListener('change',()=>{
     if(chk.checked)implementedValues.add(chk.dataset.val);
     else implementedValues.delete(chk.dataset.val);
     draw();
   });
 });
 valueList.querySelectorAll('.valLabel').forEach(lbl=>{
   lbl.addEventListener('click',()=>{
     const v=lbl.parentElement.dataset.val;
     if(implementedValues.has(v))return;
     highlightValue=(highlightValue===v?null:v);
     document.querySelectorAll('.valItem').forEach(el=>el.classList.toggle('selected',el.dataset.val===highlightValue));
     draw();
   });
 });
}

toggleGray.onclick=()=>{grayMode=!grayMode;draw();};
showFront.onclick=()=>{currentSide="front";draw();};
showBack.onclick=()=>{currentSide="back";draw();};
alphaSlider.oninput=e=>{alpha=parseFloat(e.target.value);draw();};
[scaleAdjIn,oxAdjIn,oyAdjIn].forEach(el=>el.oninput=draw);
log("準備完了：ローカル or URLからPCB/BOMを読み込めます。");
</script>
</body>
</html>